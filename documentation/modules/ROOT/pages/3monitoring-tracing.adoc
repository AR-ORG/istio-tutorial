= Observability
include::_attributes.adoc[]

[#monitoring]
== Monitoring with Grafana

Out of the box, you get monitoring via Prometheus and Grafana. 

NOTE: You may want to push some load onto the deployed applications in order to see some metrics.  Run the following command to produce the load:

[#obs-gen-load]
[source,bash,subs="+macros,+attributes"]
----
pass:[$TUTORIAL_HOME]/scripts/run.sh \
  http://customer-tutorial{namespace-suffix}.{appdomain}
----
copyToClipboard::obs-gen-load[]

[tabs]
====
cli::
+
--
ifdef::workshop[]
[#obs-open-grafana-cli]
[source,bash,subs="+macros,+attributes"]
----
open http://grafana-istio-system.{appdomain}/d/TSEY6jLmk/istio-galley-dashboard?refresh=5s&orgId=1
----
copyToClipboard::obs-open-grafana-cli[]
endif::workshop[]
ifndef::workshop[]
[#obs-open-grafana-cli2]
[source,bash,subs="+macros,+attributes"]
----
open "$(minishift openshift service grafana -u -n istio-system)/d/TSEY6jLmk/istio-galley-dashboard?refresh=5s&orgId=1"
----
copyToClipboard::obs-open-grafana-cli2[]
endif::[]
--
firefox::
+
--
ifdef::workshop[]
[#obs-open-grafana-browser]
[source,bash,subs="+macros,+attributes"]
----
firefox http://grafana-istio-system.{appdomain}/d/TSEY6jLmk/istio-galley-dashboard?refresh=5s&orgId=1
----
copyToClipboard::obs-open-grafana-browser[]
endif::[]
ifndef::workshop[]
[#obs-open-grafana-browser1]
[source,bash,subs="+macros,+attributes"]
----
firefox "$(minishift openshift service grafana -u -n istio-system)/d/TSEY6jLmk/istio-galley-dashboard?refresh=5s&orgId=1"
----
copyToClipboard::obs-open-grafana-browser1[]
endif::[]

--
====

image:grafana1.png[Grafana 1]

Check the workload of services in Grafana:

ifdef::workshop[]
[#obs-workshop-grafana-load-svc]
[source,bash,subs="+macros,+attributes"]
----
http://grafana-istio-system.{appdomain}/d/UbsSZTDik/istio-workload-dashboard?refresh=5s&orgId=1"
----
copyToClipboard::obs-workshop-grafana-load-svc[]
endif::[]

ifndef::workshop[]
[tabs]
====
cli::
+
--
[#obs-workshop-grafana-load-svc-cli]
[source,bash,subs="+macros,+attributes"]
----
open "$(minishift openshift service grafana -u -n istio-system)/d/UbsSZTDik/istio-workload-dashboard?refresh=5s&orgId=1"
----
copyToClipboard::obs-workshop-grafana-load-svc-cli[]
--
firefox::
+
--
[#obs-workshop-grafana-load-svc-firefox]
[source,bash,subs="+macros,+attributes"]
----
firefox "$(minishift openshift service grafana -u -n istio-system)/d/UbsSZTDik/istio-workload-dashboard?refresh=5s&orgId=1"
----
copyToClipboard::obs-workshop-grafana-load-svc-firefox[]
====
endif::[]

image:grafana2.png[Grafana 2]

[#prometheus]
== Prometheus

Explore Prometheus:

[tabs]
====
cli::
+
--
ifdef::workshop[]
[#obs-prometheus-open-cli1]
[source,bash,subs="+macros,+attributes"]
----
open http://prometheus-istio-system.{appdomain}/graph?g0.range_input=1m&g0.stacked=1&g0.expr=&g0.tab=0"
----
copyToClipboard::obs-prometheus-open-cli1[]
endif::[]

ifndef::workshop[]
[#obs-prometheus-open-cli2]
[source,bash,subs="+macros,+attributes"]
----
open "$(minishift openshift service prometheus -u -n istio-system)/graph?g0.range_input=1m&g0.stacked=1&g0.expr=&g0.tab=0"
----
copyToClipboard::obs-prometheus-open-cli2[]
endif::[]

--
firefox::
+
--
ifdef::workshop[]
[#obs-prometheus-open-ffox1]
[source,bash,subs="+macros,+attributes"]
----
firefox http://prometheus-istio-system.{appdomain}/graph?g0.range_input=1m&g0.stacked=1&g0.expr=&g0.tab=0"
----
copyToClipboard::obs-prometheus-open-ffox1[]
endif::[]
ifndef::workshop[]
[#obs-prometheus-open-ffox2]
[source,bash,subs="+macros,+attributes"]
----
firefox "$(minishift openshift service prometheus -u -n istio-system)/graph?g0.range_input=1m&g0.stacked=1&g0.expr=&g0.tab=0"
----
copyToClipboard::obs-prometheus-open-ffox2[]
endif::[]
--
====

// Custom Metrics removed from Workshop because it requires access to istio-system.
ifndef::workshop[] 
[#custommetrics]
=== Custom Metrics

Istio also allows you to specify custom metrics which can be seen inside of the Prometheus dashboard

Add the custom metric and rule. First make sure you are in the "istio-tutorial" directory and then
[tabs]
====
kubectl::
+
--
[#obs-pro-custom-metrics]
[source,bash,subs="+macros,+attributes"]
----
kubectl create -f link:{github-repo}/{istiofiles-dir}/recommendation_requestcount.yml[istiofiles/recommendation_requestcount.yml] -n istio-system
----
copyToClipboard::obs-pro-custom-metrics[]
--
oc::
+
--
[#obs-pro-oc-custom-metrics]
[source,bash,subs="+macros,+attributes"]
----
oc create -f link:{github-repo}/{istiofiles-dir}/recommendation_requestcount.yml[istiofiles/recommendation_requestcount.yml] -n istio-system
----
copyToClipboard::obs-pro-oc-custom-metrics[]
--
====

Then run several requests through the system

[#obs-pro-run-requests]
[source,bash,subs="+macros,+attributes"]
----
while true; do curl customer-tutorial{namespace-suffix}.{appdomain}; sleep .5;  done
----
copyToClipboard::obs-pro-run-requests[]

In the Prometheus dashboard, add the following

[#obs-pro-run-query]
[source,bash,subs="+macros,+attributes"]
----
istio_requests_total{destination_service="recommendation.tutorial.svc.cluster.local"}
----
copyToClipboard::obs-pro-run-query[]

and select `Execute`

image:prometheus_custom_metric.png[alt text]

NOTE: You may have to refresh the browser for the Prometheus graph to update. And you may wish to make the interval 5m (5 minutes) as seen in the screenshot above.

[#containermemory]
=== Containers memory

Istio allows also to see the RSS memory consumed by the containers.

In the Prometheus dashboard, add the following

[#obs-pro-run-container-mem]
[source,bash,subs="+macros,+attributes"]
----
container_memory_rss{namespace="tutorial",container_name =~ "customer|preference|recommendation"}
----
copyToClipboard::obs-pro-run-container-mem[]

and select `Execute`

image:prometheus-memory.png[Prometheus memory]

[#applicationmetrics]
=== Application metrics

The deployment file for each microservice contains the following annotations:

[#obs-pro-annotations]
[source,yaml,subs="+macros,+attributes"]
----
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/scheme: "http"
----
copyToClipboard::obs-pro-annotations[]

IMPORTANT: Please ensure the indentation of the deployment YAML is right after pasting the values.

These annotations cause Prometheus to query the "/metrics" path and collect the data.

In the Prometheus dashboard, add the following expression to look at one of these metrics

[#obs-pro-run-base-mem-query]
[source,bash,subs="+macros,+attributes"]
----
base:memory_used_heap_bytes
----
copyToClipboard::obs-pro-run-base-mem-query[]

and select `Execute`

image:prometheus-appmetrics.png[application metrics]

endif::[]

[#tracing]
== Tracing

Distributed Tracing involves propagating the tracing context from service to service, usually done by sending certain incoming HTTP headers downstream to outbound requests. For services embedding a http://opentracing.io/[OpenTracing] framework instrumentations such as https://github.com/opentracing-contrib/java-spring-cloud[opentracing-spring-cloud], this might be transparent. For services that are not embedding OpenTracing libraries, this context propagation needs to be done manually.

As OpenTracing is "just" an instrumentation library, a concrete tracer is required in order to actually capture the tracing data and report it to a remote server. Our `customer` and `preference` services ship with http://jaegertracing.io/[Jaeger] as the concrete tracer. the Istio platform automatically sends collected tracing data to Jaeger, so that we are able to see a trace involving all three services, even if our `recommendation` service is not aware of OpenTracing or Jaeger at all.

Our `customer` and `preference` services are using the https://github.com/jaegertracing/jaeger-client-java/tree/master/jaeger-tracerresolver[`TracerResolver`] facility from OpenTracing, so that the concrete tracer can be loaded automatically without our code having a hard dependency on Jaeger. Given that the Jaeger tracer can be configured via environment variables, we don't need to do anything in order to get a properly configured Jaeger tracer ready and registered with OpenTracing. That said, there are cases where it's appropriate to manually configure a tracer. Refer to the Jaeger documentation for more information on how to do that.

Let's open the Jaeger console, select `customer` from the list of services and click `Find Traces`

ifdef::workshop[]

[tabs]
====
cli::
+
--
[#obs-tracing-open-cli]
[source,bash,subs="+macros,+attributes"]
----
open https://jaeger-query-istio-system.{appdomain}/
----
copyToClipboard::obs-tracing-open-cli[]
--
firefox::
+
--
[#obs-tracing-open-ffox]
[source,bash,subs="+macros,+attributes"]
----
firefox https://jaeger-query-istio-system.{appdomain}/
----
copyToClipboard::obs-tracing-open-ffox[]
--
====

endif::workshop[]

ifndef::workshop[]
[tabs]
====
minikube::
+
--
[#obs-tracing-open-minikube]
[source,bash,subs="+macros,+attributes"]
----
minikube service tracing -n istio-system --in-browser
----
--
minishift::
+
--
[#obs-tracing-open-minishift]
[source,bash,subs="+macros,+attributes"]
----
minishift openshift service tracing -n istio-system --in-browser
----
--
====
endif::workshop[]


image:jaegerUI.png[Trace as seen in Jaeger]
